## kiam-secrets helm chart

This chart is provided to quickly bootstrap a kiam installation with TLS certificates. Note, though,
if you change the release of that chart, those secrets will be rotated, and you will have to 
restart all your kiam pods.

For production you should generate your certificates in advance. More information can be found 
[here](https://github.com/uswitch/kiam/blob/master/docs/TLS.md).

It is expected that this chart and kiam will be installed as the following. Any deviation from
this may result in TLS errors (see below)

```bash
helm upgrade --install kiam-secrets kiam-secrets --namespace kube-system
helm upgrade --install kiam stable/kiam --namespace kube-system --values values.yaml
```

Further, the _kiam_ `values.yaml` must contain the following:

```yaml
agent:
  # This secret is autogenerated as part of the kiam-secrets chart
  tlsSecret: kiam-agent-tls
server:
  # This secret is autogenerated as part of the kiam-secrets chart
  tlsSecret: kiam-server-tls
```

### Troubleshooting

##### kiam-agent log: "error creating server gateway: error dialing grpc server: context deadline exceeded"

This is usually because the TLS configuration is not correct. Critically, the certificate served
up by the kiam-server must have a domain name that matches the one that the kiam-agent is using to
connect to.

If you can, jump into a running kiam-agent box, and run the following. The output of the error
may help you reconcile the certificate CA name. Most likely you will want to change the 
`$serverCert := genSignedCert...` line in the chart template.

```bash
apk add curl
curl -v \
  --cacert /etc/kiam/tls/ca \
  --key /etc/kiam/tls/key \
  --cert /etc/kiam/tls/cert \
  https://kiam-server -v
```

You may see an output like this

```
* subjectAltName does not match kiam-server
* SSL: no alternative certificate subject name matches target host name 'kiam-server'
* Closing connection 0
* TLSv1.2 (OUT), TLS alert, close notify (256):
curl: (51) SSL: no alternative certificate subject name matches target host name 'kiam-server'
```
